<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSP Protocol Specification</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #f8f9fa;
            padding: 2rem;
            border-radius: 5px;
            margin-bottom: 2rem;
        }
        .section {
            margin-bottom: 3rem;
        }
        h2 {
            color: #0066cc;
            margin-top: 2rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        h3 {
            color: #0066cc;
            margin-top: 1.5rem;
        }
        pre {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 5px;
            overflow-x: auto;
        }
        code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        .footer {
            text-align: center;
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 1px solid #eee;
            color: #666;
        }
        .nav-item {
            margin-right: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>PersistentSessionsProtocol Specification</h1>
        <p class="lead">A unified approach to browser session persistence</p>
        <nav class="nav">
            <a class="nav-link" href="../">Home</a>
            <a class="nav-link" href="#introduction">Introduction</a>
            <a class="nav-link" href="#architecture">Architecture</a>
            <a class="nav-link" href="#data-model">Data Model</a>
            <a class="nav-link" href="#api">API</a>
        </nav>
    </div>

    <div class="section" id="introduction">
        <h2>1. Introduction</h2>
        
        <h3>1.1 Motivation</h3>
        <p>
            Browser automation tools handle session persistence in fundamentally different ways, creating significant interoperability 
            problems for developers. The PersistentSessionsProtocol establishes a unified method for capturing, storing, transmitting, 
            and replaying browser sessions across Playwright, Selenium, Skyvern, and other major frameworks.
        </p>
        
        <h3>1.2 Goals</h3>
        <ul>
            <li>Provide a framework-agnostic method for persisting browser state</li>
            <li>Enable seamless session transfer between different tools and environments</li>
            <li>Support both local and remote session storage</li>
            <li>Ensure security for sensitive session data</li>
            <li>Minimize implementation complexity for framework adapters</li>
        </ul>
    </div>

    <div class="section" id="architecture">
        <h2>2. Core Architecture</h2>
        
        <p>PSP employs a layered architecture with four distinct components:</p>
        
        <h3>2.1 Session Capture Layer</h3>
        <p>The capture layer extracts state through:</p>
        <ul>
            <li><strong>Storage APIs</strong>: Cookies, localStorage, sessionStorage access</li>
            <li><strong>DOM Introspection</strong>: HTML structure and state</li>
            <li><strong>Network Interception</strong>: Captured requests and responses</li>
            <li><strong>Browser APIs</strong>: Navigation state through History API</li>
            <li><strong>Input Recording</strong>: User interactions and timing</li>
        </ul>
        <p>Framework adapters translate between PSP's structures and framework implementations.</p>
        
        <h3>2.2 Serialization and Transport Layer</h3>
        <p>Data serialization uses:</p>
        <ul>
            <li><strong>Primary format</strong>: Protocol Buffers for efficient binary encoding</li>
            <li><strong>Fallback format</strong>: JSON for debugging and compatibility</li>
            <li><strong>Differential updates</strong>: Only changed state components transmitted</li>
            <li><strong>Compression</strong>: Selective compression for large assets</li>
        </ul>
        
        <h3>2.3 Storage Layer</h3>
        <p>Multiple backend options supported:</p>
        <ul>
            <li><strong>Local filesystem</strong>: For single-machine persistence</li>
            <li><strong>Redis</strong>: For production deployments</li>
            <li><strong>Databases</strong>: SQL/NoSQL for existing infrastructure</li>
            <li><strong>Cloud object storage</strong>: For distributed access</li>
        </ul>
        
        <h3>2.4 Replay Layer</h3>
        <p>Session restoration through:</p>
        <ul>
            <li><strong>State restoration</strong>: Direct application of serialized state</li>
            <li><strong>Event replay</strong>: Chronological event playback</li>
            <li><strong>Network simulation</strong>: Mocked or pass-through responses</li>
            <li><strong>Timing control</strong>: Options for replay speed</li>
        </ul>
    </div>

    <div class="section" id="data-model">
        <h2>3. Data Model</h2>
        
        <h3>3.1 Session State</h3>
        <pre><code>interface BrowserSessionState {
  version: string;
  timestamp: number;
  origin: string;
  storage: StorageState;
  dom?: DOMState;
  history?: HistoryState;
  network?: NetworkState;
  recording?: RecordingState;
}</code></pre>
        
        <h3>3.2 Storage State</h3>
        <pre><code>interface StorageState {
  cookies: Cookie[];
  localStorage: Map<string, Map<string, string>>;  // Origin to key-value map
  sessionStorage: Map<string, Map<string, string>>;
  indexedDB?: IndexedDBState;
  cacheStorage?: CacheStorageState;
}

interface Cookie {
  name: string;
  value: string;
  domain: string;
  path: string;
  expires: number | null;
  httpOnly: boolean;
  secure: boolean;
  sameSite: "Strict" | "Lax" | "None";
  partitioned: boolean;  // For CHIPS (Cookie Having Independent Partitioned State)
}</code></pre>
        
        <h3>3.3 Authentication State</h3>
        <pre><code>interface AuthenticationState {
  tokens: AuthToken[];
  credentials?: EncryptedCredentials;  // Only with explicit permission
}

interface AuthToken {
  type: string;  // "Bearer", "JWT", "OAuth", etc.
  value: string;
  scope?: string[];
  expiresAt?: number;
  refreshToken?: string;
  isHttpOnly: boolean;
  domain: string;
}</code></pre>
        
        <h3>3.4 Navigation State</h3>
        <pre><code>interface NavigationState {
  currentUrl: string;
  entries: HistoryEntry[];
  currentIndex: number;
}

interface HistoryEntry {
  url: string;
  title: string;
  state?: object;  // History state object
  scrollPosition?: { x: number, y: number };
  timestamp: number;
}</code></pre>
        
        <h3>3.5 Recording State</h3>
        <pre><code>interface RecordingState {
  events: Event[];
  startTime: number;
  duration: number;
}

interface Event {
  type: string;  // "click", "keydown", "timer", "network", etc.
  timestamp: number;
  target?: string;  // CSS selector or XPath
  data: object;  // Event-specific data
}</code></pre>
    </div>

    <div class="section" id="api">
        <h2>4. API Specification</h2>
        
        <h3>4.1 Core Client API</h3>
        <pre><code>interface PSPSession {
  // Session management
  create(options?: SessionOptions): Promise<Session>;
  load(sessionId: string): Promise<Session>;
  list(filter?: SessionFilter): Promise<SessionInfo[]>;
  delete(sessionId: string): Promise<void>;

  // State operations
  capture(page: BrowserPage): Promise<void>;
  restore(page: BrowserPage): Promise<void>;
  
  // Recording operations
  startRecording(options?: RecordingOptions): Promise<void>;
  stopRecording(): Promise<void>;
  playRecording(options?: PlaybackOptions): Promise<void>;
}</code></pre>
        
        <h3>4.2 Server REST API</h3>
        <pre><code>GET    /sessions                # List sessions
POST   /sessions                # Create a new session
GET    /sessions/:id            # Get session by ID
PUT    /sessions/:id            # Update session
DELETE /sessions/:id            # Delete session
PATCH  /sessions/:id            # Partial update
GET    /sessions/:id/events     # Get recorded events
POST   /sessions/:id/events     # Add events to session</code></pre>
        
        <h3>4.3 WebSocket API</h3>
        <pre><code>// Event types
type PSPWebSocketEvent = 
  | { type: 'session.update', data: BrowserSessionState }
  | { type: 'session.event', data: Event }
  | { type: 'session.deleted', data: { id: string } };

// Connection message for subscribing to session updates
interface PSPWebSocketConnect {
  action: 'subscribe';
  sessionId: string;
  token: string;  // Authentication token
}</code></pre>
    </div>

    <div class="section">
        <h2>5. Implementation Guidelines</h2>
        
        <h3>5.1 Adapter Implementation</h3>
        <p>Framework adapters must implement:</p>
        <ol>
            <li><strong>State capture</strong>: Extract browser state via framework APIs</li>
            <li><strong>State restoration</strong>: Apply state to browser context</li>
            <li><strong>Event recording</strong>: Capture user interactions</li>
            <li><strong>Event replay</strong>: Reproduce recorded actions</li>
        </ol>
        
        <h3>5.2 Storage Backend Implementation</h3>
        <p>Storage backends must provide:</p>
        <ol>
            <li><strong>CRUD operations</strong>: Basic session management</li>
            <li><strong>Query capability</strong>: Find sessions by metadata</li>
            <li><strong>Transaction support</strong>: Atomic operations</li>
            <li><strong>TTL support</strong>: Automatic session expiration</li>
            <li><strong>Compression</strong>: Optional data compression</li>
        </ol>
    </div>

    <div class="footer">
        <p>PersistentSessionsProtocol Â© 2023 | <a href="https://github.com/samihalawa/PSP-PersistentSessionsProtocol">GitHub</a></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>